import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:resqpet/entities/segnalazione.dart'; 
import 'dao.dart'; 

class SegnalazioneDao implements Dao<Segnalazione, String> {
  
  static const segnalazioneCollection = "segnalazioni";
  final FirebaseFirestore _firestore;

  SegnalazioneDao(this._firestore);

  @override
  Future<Segnalazione> create(Segnalazione data) async {
    // Aggiunge il documento (Firestore genera l'ID)
    final doc = await _firestore.collection(segnalazioneCollection)
      .add(data.toFirestore());

    // Recupera l'oggetto appena creato per restituirlo completo di ID
    final ref = await doc.withConverter(
      fromFirestore: Segnalazione.fromFirestore, 
      toFirestore: (segnalazione, _) => segnalazione.toFirestore()
    ).get();

    return ref.data()!;
  }

  @override
  Future<void> deleteById(String id) async {
    await _firestore.collection(segnalazioneCollection)
      .doc(id)
      .delete();
  }

  @override
  Future<List<Segnalazione>> findAll() async {
    final querySnapshot = await _firestore.collection(segnalazioneCollection)
      .withConverter(
        fromFirestore: Segnalazione.fromFirestore,
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      ).get();

    return querySnapshot.docs
      .map((doc) => doc.data())
      .toList();
  }

  @override
  Stream<List<Segnalazione>> findAllStream() {
    return _firestore.collection(segnalazioneCollection)
      .withConverter(
        fromFirestore: Segnalazione.fromFirestore,
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      )
      .snapshots()
      .map((snapshot) {
        return snapshot.docs
          .map((doc) => doc.data())
          .toList();
      });
  }

  @override
  Future<Segnalazione?> findById(String id) async {
    final ref = await _firestore.collection(segnalazioneCollection)
      .doc(id)
      .withConverter(
        fromFirestore: Segnalazione.fromFirestore, 
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      )
      .get();

    return ref.data();
  }

  @override
  Future<Segnalazione> update(Segnalazione data) async {
    if (data.id == null) {
      throw Exception("Expected non-null id for update!");
    }

    // Utilizzo .set 
    await _firestore.collection(segnalazioneCollection)
      .doc(data.id)
      .withConverter<Segnalazione>(
        fromFirestore: Segnalazione.fromFirestore, 
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      )
      .set(data);

    final ref = await _firestore.collection(segnalazioneCollection)
      .doc(data.id)
      .withConverter(
        fromFirestore: Segnalazione.fromFirestore, 
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      ).get();

    return ref.data()!;
  }

  // --- Metodi Aggiuntivi per coprire i requisiti SDD ---

  /// Permette di recuperare le segnalazioni assegnate a un Soccorritore specifico.
  /// Necessario per il requisito "Prende in carico segnalazione" e "Visualizza segnalazioni" [SDD 4.2]
  Future<List<Segnalazione>> findBySoccorritore(String soccorritoreId) async {
    final querySnapshot = await _firestore.collection(segnalazioneCollection)
      .where('soccorritore_ref', isEqualTo: soccorritoreId)
      .withConverter(
        fromFirestore: Segnalazione.fromFirestore,
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      ).get();

    return querySnapshot.docs.map((doc) => doc.data()).toList();
  }

  /// Permette di recuperare lo storico delle segnalazioni di un Cittadino.
  /// Necessario per il requisito "Lista segnalazioni" lato cittadino [SDD 4.2]
  Future<List<Segnalazione>> findByCittadino(String cittadinoId) async {
    final querySnapshot = await _firestore.collection(segnalazioneCollection)
      .where('cittadino_ref', isEqualTo: cittadinoId)
      .withConverter(
        fromFirestore: Segnalazione.fromFirestore,
        toFirestore: (segnalazione, _) => segnalazione.toFirestore()
      ).get();

    return querySnapshot.docs.map((doc) => doc.data()).toList();
  }
}
